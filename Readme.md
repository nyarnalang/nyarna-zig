# Reference Nyarna Implementation

This is the reference [Nyarna][3] implementation, written in Zig.

## Building

Nyarna currently depends on zig master, but has not yet been updated for stage2.
A release will not be available before zig 0.10.0 drops.

[Nix Flakes][1] are used as build system.
This pins the versions of zig and third-party libraries.
You can install Nix on most Linux distributions and macOS.
With Nix installed and Flakes enabled, you can simply do

    nix build github:nyarnalang/nyarna-zig#cli

to get the CLI in `result`.

The plan is to release a source tarball with sources generated by Nix for people on platforms without Nix support (e.g. Windows) once zig 0.10.0 drops.
Meanwhile, Windows users can use WSL.

There's theoretical cross-compilation support available via

    nix build github:nyarnalang/nyarna-zig#cli_win64

which generates a zip file you can extract.
However this is known to segfault currently.

## Development

Assumes being in checked-out repository.

`nix build .#cli` builds the command-line executable.

`nix build .#wasm` builds the WASM library with JavaScript interface used for the tour on the website.

`nix develop` starts a bash session where you can do:

 * `eval "$configurePhase"` to generate `build.zig`.
 * `eval "$buildPhase"` to compile (requires `build.zig`)
 * `eval "$checkPhase"` to run the tests ()

This should be easier but is currently blocked by [this Nix issue][2].
After generating `build.zig` once, you can also do `zig build` and `zig build test`.
This is how I develop.

### Debugging

After configuring, you can generate the tests and can also debug them:

 * `zig build test -Demit_bin=true` will give you executables for all tests.
 * use `-Dtest-filter="Schema extension"` to run only a specific test.
 * use `lldb -- ./outputTest $(which zig)` to debug a test executable (needs lldb on your system).

The `configurePhase` also generates a `.vscode` folder usable with [Visual Studio Code][4] that contains debug configurations.
You will need to have configured LLDB in your editor.
There is a configuration available for each test executable â€“ you need to have generated the executable manually as described above.
The tests are not generated automatically by the debug configurations so that you can generate and use filtered executables.

## License

[MIT](/License.md)

 [1]: https://nixos.wiki/wiki/Flakes
 [2]: https://github.com/NixOS/nix/issues/6202
 [3]: https://nyarna.org
 [4]: https://code.visualstudio.com